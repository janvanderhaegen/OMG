# OMG - Open Modular Gardening – Session Log

- Date: 2026-03-02
- Duration: N/A
- Related user stories: US08, US09, US10

## Context

Session implemented plant management for US08–US10 per the attached plan: domain (Plant entity, Garden owning plants, surface area invariant), persistence (PlantEntity, migration), REST endpoints (POST/GET/PUT/DELETE under `/api/v1/management/gardens/{gardenId}/plants`), and tests. Then plant update was refactored so the REST PUT does not support updating id and only calls specific domain methods when the request value actually changed: Rename (PlantRenamedEvent), Reclassify (PlantReclassified – species and type together), DefineSurfaceAreaRequirement (SurfaceAreaRequirementChanged), AdjustIdealHumidity (IdealHumidityLevelChanged), and SetPlantationDate (PlantationDateChanged). Finalize run fixed AddPlant error code (GardenValidationFailed) and the UpdatePlant API test (plantation date must be in the past; use past date in test).

## What was done

- **Domain**: Added `Plant`, `PlantId`, `PlantType`; extended `Garden` with `_plants`, `AddPlant`, `RenamePlant`, `ReclassifyPlant`, `DefineSurfaceAreaRequirement`, `AdjustIdealHumidity`, `SetPlantationDate`, `RemovePlant`; surface area invariant enforced in AddPlant and DefineSurfaceAreaRequirement; domain events for add/rename/reclassify/surface area/ideal humidity/plantation date/remove.
- **Persistence**: `PlantEntity`, `gm.plants` table, FK to gardens with cascade delete; EF migration AddPlants; `GardenRepository.GetByIdWithPlantsAsync` and mapping for plants; plant persistence from endpoints via `ManagementDbContext` for create/update/delete.
- **API**: `ManagementPlantEndpoints` with POST/GET list/GET by id/PUT/DELETE; DTOs `CreatePlantRequest`, `UpdatePlantRequest`, `PlantResponse`; PUT compares request to current plant and calls only Rename/Reclassify/DefineSurfaceAreaRequirement/AdjustIdealHumidity/SetPlantationDate when value changed; validation and ProblemDetails on failure.
- **Messaging**: Integration events `PlantAdded`, `PlantRemoved`, `PlantRenamed`, `PlantReclassified`, `PlantSurfaceAreaRequirementChanged`, `PlantIdealHumidityLevelChanged`, `PlantPlantationDateChanged`; `GardenIntegrationEventPublisher` maps and publishes them.
- **Tests**: Domain tests in `GardenPlantTests` for AddPlant (success, surface area violation, validation), Rename/Reclassify/DefineSurfaceAreaRequirement/AdjustIdealHumidity (success, no-op, validation); API tests in `PlantManagementEndpointTests` for list, get, create, create surface area failure, update, delete.
- **Finalize**: `Garden.AddPlant` error code set to `GardenValidationFailed` for test expectations; UpdatePlant test uses past plantation date; PUT uses trimmed name/species and fallback to current species when request species is null.

## Design decisions

- Plant id is never updatable (from route only). Update is modeled as separate domain methods and events per concern (rename, reclassify, surface area, ideal humidity, plantation date); REST PUT invokes only the methods whose request value differs from current state.
- Reclassify updates species and type together; API always sends both and endpoint uses `request.Species?.Trim() ?? plant.Species` when calling Reclassify so null/empty request species does not cause validation failure.
- SetPlantationDate enforces “plantation date must be in the past” (≤ utcNow); API test updated to send a past date.
